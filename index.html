<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baked Bliss - Spin & Win!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #A40606; /* Deep Festive Red */
            background-image: linear-gradient(315deg, #A40606 0%, #D98324 74%); /* Red to Gold Gradient */
            overflow: hidden; 
        }
        .baking-bliss-title {
            font-family: 'Pacifico', cursive;
        }
        .wheel-svg {
            width: 100%;
            height: 100%;
            transition: transform 4s cubic-bezier(0.25, 1, 0.5, 1);
            filter: drop-shadow(0 0 15px rgba(0,0,0, 0.3));
        }
        .wheel-container {
            -webkit-tap-highlight-color: transparent;
        }
        .prize-symbol {
            font-size: 48px;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f0f;
            opacity: 0.7;
            animation: fall 3s linear forwards;
        }
        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        .background-animation .item {
            position: absolute;
            bottom: -100px;
            font-size: 2rem;
            animation: float 20s linear infinite;
            opacity: 0.3;
            color: #FFD700; /* Gold color for sparkles */
        }
        @keyframes float {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 0.3;
            }
            100% {
                transform: translateY(-120vh) rotate(720deg);
                opacity: 0;
            }
        }
        /* --- New Modal Animation --- */
        .modal-content {
             animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div class="background-animation" id="background-animation"></div>

    <header class="text-center mb-6 z-10">
        <h1 class="text-6xl font-black text-white baking-bliss-title" style="text-shadow: 2px 2px 6px rgba(0,0,0,0.5);">Baked Bliss</h1>
        <p class="text-xl text-white font-semibold">Spin to Win Sweet Treats!</p>
    </header>

    <div class="relative flex flex-col items-center z-10">
        <div class="absolute -top-4 z-10">
            <div class="w-0 h-0 border-l-[20px] border-l-transparent border-r-[20px] border-r-transparent border-t-[30px] border-t-yellow-300 drop-shadow-lg"></div>
        </div>

        <div class="wheel-container relative w-80 h-80 md:w-96 md:h-96 my-8 flex items-center justify-center">
            <div id="wheel" class="w-full h-full"></div>
            <div id="spinTrigger" class="absolute w-24 h-24 bg-red-600 rounded-full border-4 border-yellow-300 shadow-lg flex items-center justify-center cursor-pointer transform active:scale-95 transition-transform">
                <span class="text-white text-3xl font-black" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.4);">SPIN</span>
            </div>
        </div>
    </div>
    
    <div id="resultModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
         <div id="confetti-container" class="absolute inset-0 overflow-hidden pointer-events-none"></div>
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 text-center max-w-sm w-full transform transition-all scale-95 opacity-0">
             <div class="modal-content">
                <h2 class="text-2xl font-black text-red-600 mb-2">YOU WON!</h2>
                <p id="prizeName" class="text-4xl font-bold text-gray-800 my-4 leading-tight"></p>
                <p class="text-gray-600 mb-4">Show this screen to our staff to redeem!</p>
                <div class="bg-gray-100 rounded-lg p-3 my-4">
                    <span class="text-sm text-gray-500">UNIQUE CODE</span>
                    <p id="prizeId" class="text-2xl font-mono tracking-widest"></p>
                </div>
                
                <div id="geminiFeatures" class="mt-6 space-y-4">
                    <div id="geminiButtons" class="grid grid-cols-1 gap-3">
                        <button id="fortuneButton" class="w-full bg-amber-500 text-white font-bold py-3 px-4 rounded-lg text-lg transform hover:scale-105 transition-transform">
                            ‚ú® Get Your Sweet Fortune!
                        </button>
                        <button id="funFactButton" class="w-full bg-sky-500 text-white font-bold py-3 px-4 rounded-lg text-lg transform hover:scale-105 transition-transform">
                            üßÅ Get a Baker's Fun Fact!
                        </button>
                        <button id="nicknameButton" class="w-full bg-purple-500 text-white font-bold py-3 px-4 rounded-lg text-lg transform hover:scale-105 transition-transform">
                            üéâ Name Your Treat!
                        </button>
                    </div>

                    <div id="fortuneContainer">
                        <div id="fortuneLoading" class="hidden my-4 text-gray-500">
                            Baking your fortune... ü•†
                        </div>
                        <div id="fortuneResult" class="hidden mt-4 p-4 bg-amber-100 border-l-4 border-amber-500 text-amber-800 rounded-r-lg">
                            <p id="fortuneText" class="text-lg italic"></p>
                        </div>
                    </div>

                    <div id="funFactContainer">
                         <div id="funFactLoading" class="hidden my-4 text-gray-500">
                            Looking up a fun fact... üìú
                        </div>
                        <div id="funFactResult" class="hidden mt-4 p-4 bg-sky-100 border-l-4 border-sky-500 text-sky-800 rounded-r-lg">
                            <p id="funFactText" class="text-lg"></p>
                        </div>
                    </div>

                    <div id="nicknameContainer">
                         <div id="nicknameLoading" class="hidden my-4 text-gray-500">
                            Inventing a legendary name... ‚ú®
                        </div>
                        <div id="nicknameResult" class="hidden mt-4 p-4 bg-purple-100 border-l-4 border-purple-500 text-purple-800 rounded-r-lg">
                            <p class="text-gray-600 text-sm">Your treat shall henceforth be known as:</p>
                            <p id="nicknameText" class="text-2xl font-bold"></p>
                        </div>
                    </div>
                </div>
                
                <button id="closeModalButton" class="mt-8 w-full bg-gray-700 text-white font-bold py-3 px-4 rounded-lg text-lg transform hover:scale-105 transition-transform">
                    Awesome!
                </button>
            </div>
        </div>
    </div>

    <!-- "Already Spun" Modal -->
    <div id="alreadySpunModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 text-center max-w-sm w-full transform transition-all scale-95 opacity-0">
            <div class="modal-content">
                <div class="text-6xl mb-4">ü§î</div>
                <h2 class="text-2xl font-black text-gray-800 mb-2">Whoops!</h2>
                <p class="text-gray-600 mb-6">You've already had your spin for today. Come back tomorrow for another chance to win!</p>
                <button id="closeAlreadySpunModalButton" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg text-lg transform hover:scale-105 transition-transform">
                    Got It!
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyDauZ3AwxVRK_mvRT89qsXW4g84cgq8Rjc",
            authDomain: "bakingblisswheel.firebaseapp.com",
            projectId: "bakingblisswheel",
            storageBucket: "bakingblisswheel.appspot.com",
            messagingSenderId: "1020604226536",
            appId: "1:1020604226536:web:2d50898e9dc5193d88225d"
        };
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, where, limit, getDocs, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const spinTrigger = document.getElementById('spinTrigger');
        const wheelContainer = document.getElementById('wheel');
        const resultModal = document.getElementById('resultModal');
        const prizeNameEl = document.getElementById('prizeName');
        const prizeIdEl = document.getElementById('prizeId');
        const closeModalButton = document.getElementById('closeModalButton');
        const confettiContainer = document.getElementById('confetti-container');
        const alreadySpunModal = document.getElementById('alreadySpunModal');
        const closeAlreadySpunModalButton = document.getElementById('closeAlreadySpunModalButton');
        
        const geminiButtons = document.getElementById('geminiButtons');
        const fortuneButton = document.getElementById('fortuneButton');
        const fortuneLoading = document.getElementById('fortuneLoading');
        const fortuneResult = document.getElementById('fortuneResult');
        const fortuneText = document.getElementById('fortuneText');
        const funFactButton = document.getElementById('funFactButton');
        const funFactLoading = document.getElementById('funFactLoading');
        const funFactResult = document.getElementById('funFactResult');
        const funFactText = document.getElementById('funFactText');
        const nicknameButton = document.getElementById('nicknameButton');
        const nicknameLoading = document.getElementById('nicknameLoading');
        const nicknameResult = document.getElementById('nicknameResult');
        const nicknameText = document.getElementById('nicknameText');
        let currentPrize = '';

        const prizes = [ "THE GANG BONUS!", "‚Çπ25 OFF any Slice Cake", "THE INFLUENCER DEAL", "BUY 1 CUPCAKE, GET 1 HALF OFF", "‚Çπ50 OFF on ‚Çπ275+", "ADD A CUPCAKE FOR ‚Çπ25!", "DOUBLE YOUR LUCK", "‚Çπ20 OFF ANY BROWNIE" ];
        const prizeSymbols = ["üôå", "üç∞", "ü§≥", "üßÅ+üßÅ", "üí∞", "+üßÅ", "üçÄ", "üç´"];
        
        const dailyStrategies = {
            day1: [ { prize: "DOUBLE YOUR LUCK", weight: 30 }, { prize: "THE INFLUENCER DEAL", weight: 25 }, { prize: "‚Çπ20 OFF ANY BROWNIE", weight: 15 }, { prize: "BUY 1 CUPCAKE, GET 1 HALF OFF", weight: 15 }, { prize: "ADD A CUPCAKE FOR ‚Çπ25!", weight: 10 }, { prize: "‚Çπ25 OFF any Slice Cake", weight: 10 }, { prize: "‚Çπ50 OFF on ‚Çπ275+", weight: 4 }, { prize: "THE GANG BONUS!", weight: 1 } ],
            day2: [ { prize: "ADD A CUPCAKE FOR ‚Çπ25!", weight: 25 }, { prize: "‚Çπ20 OFF ANY BROWNIE", weight: 20 }, { prize: "BUY 1 CUPCAKE, GET 1 HALF OFF", weight: 20 }, { prize: "DOUBLE YOUR LUCK", weight: 15 }, { prize: "THE INFLUENCER DEAL", weight: 10 }, { prize: "‚Çπ25 OFF any Slice Cake", weight: 10 }, { prize: "‚Çπ50 OFF on ‚Çπ275+", weight: 8 }, { prize: "THE GANG BONUS!", weight: 2 } ],
            day3: [ { prize: "‚Çπ50 OFF on ‚Çπ275+", weight: 30 }, { prize: "ADD A CUPCAKE FOR ‚Çπ25!", weight: 25 }, { prize: "THE GANG BONUS!", weight: 10 }, { prize: "BUY 1 CUPCAKE, GET 1 HALF OFF", weight: 15 }, { prize: "‚Çπ20 OFF ANY BROWNIE", weight: 15 }, { prize: "‚Çπ25 OFF any Slice Cake", weight: 5 }, { prize: "DOUBLE YOUR LUCK", weight: 3 }, { prize: "THE INFLUENCER DEAL", weight: 2 } ],
            day4: [ { prize: "‚Çπ50 OFF on ‚Çπ275+", weight: 30 }, { prize: "ADD A CUPCAKE FOR ‚Çπ25!", weight: 25 }, { prize: "THE GANG BONUS!", weight: 10 }, { prize: "BUY 1 CUPCAKE, GET 1 HALF OFF", weight: 15 }, { prize: "‚Çπ20 OFF ANY BROWNIE", weight: 15 }, { prize: "‚Çπ25 OFF any Slice Cake", weight: 5 }, { prize: "DOUBLE YOUR LUCK", weight: 3 }, { prize: "THE INFLUENCER DEAL", weight: 2 } ],
        };

        let isSpinning = false;
        let currentRotation = 0;
        let db;
        let wheelSVG;

        function drawWheel() {
            const numSegments = prizes.length;
            const size = 384; 
            const radius = size / 2;
            const colors = ["#FFFDD0", "#FFFFFF", "#FFFDD0", "#FFFFFF", "#FFFDD0", "#FFFFFF", "#FFFDD0", "#FFFFFF"];
            
            let svgContent = `<svg class="wheel-svg" viewBox="0 0 ${size} ${size}">`;

            for (let i = 0; i < numSegments; i++) {
                const startAngle = i * (360 / numSegments);
                const endAngle = (i + 1) * (360 / numSegments);
                const largeArcFlag = (endAngle - startAngle) <= 180 ? "0" : "1";
                const start = polarToCartesian(radius, radius, endAngle);
                const end = polarToCartesian(radius, radius, startAngle);

                const pathData = `M ${start.x} ${start.y} A ${radius} ${radius} 0 ${largeArcFlag} 0 ${end.x} ${end.y} L ${radius} ${radius} Z`;
                svgContent += `<path d="${pathData}" fill="${colors[i]}" stroke="#E5E7EB" stroke-width="2" />`;

                const symbolAngle = startAngle + (360 / numSegments) / 2;
                const symbolPosition = polarToCartesian(radius, radius * 0.65, symbolAngle);
                svgContent += `<text x="${symbolPosition.x}" y="${symbolPosition.y}" dy=".3em" text-anchor="middle" class="prize-symbol">${prizeSymbols[i]}</text>`;
            }

            svgContent += `</svg>`;
            wheelContainer.innerHTML = svgContent;
            wheelSVG = wheelContainer.querySelector('.wheel-svg');
        }

        function polarToCartesian(centerX, radius, angleInDegrees) {
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return {
                x: centerX + (radius * Math.cos(angleInRadians)),
                y: centerX + (radius * Math.sin(angleInRadians))
            };
        }
        
        function initializeFirebase() {
             if (firebaseConfig.apiKey === "YOUR_API_KEY" || !firebaseConfig.projectId) {
                console.warn("Firebase config is not set. Using offline mode.");
                return null;
            }
            try {
                const app = initializeApp(firebaseConfig);
                return getFirestore(app);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                return null;
            }
        }
        
        function createBackgroundItems() {
            const container = document.getElementById('background-animation');
            const items = ['‚ú®', '‚≠ê', 'üíñ', 'üç∞'];
            const itemCount = 20;

            for (let i = 0; i < itemCount; i++) {
                const item = document.createElement('span');
                item.className = 'item';
                item.textContent = items[Math.floor(Math.random() * items.length)];
                item.style.left = `${Math.random() * 100}vw`;
                item.style.animationDuration = `${15 + Math.random() * 15}s`;
                item.style.animationDelay = `${Math.random() * 10}s`;
                item.style.fontSize = `${1 + Math.random() * 1.5}rem`;
                container.appendChild(item);
            }
        }

        drawWheel();
        createBackgroundItems();
        db = initializeFirebase();

        async function getRiggedPrize(strategy) {
            const availablePrizes = dailyStrategies[strategy].filter(s => prizes.includes(s.prize));
            const totalWeight = availablePrizes.reduce((sum, p) => sum + p.weight, 0);
            let random = Math.random() * totalWeight;
            for (const prize of availablePrizes) {
                if (random < prize.weight) return prizes.indexOf(prize.prize);
                random -= prize.weight;
            }
            return 0;
        }
        
        async function getNextCode() {
            if (!db) return "OFFLINE-" + Math.random().toString(36).substring(2, 8).toUpperCase();
            const counterRef = doc(db, "codes", "counter");
            let nextCode = "BLISS-00001";
            try {
                await runTransaction(db, async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    let newCount = counterDoc.exists() ? counterDoc.data().count + 1 : 1;
                    const codeNum = newCount.toString().padStart(5, '0');
                    const codeId = `code_${codeNum}`;
                    const codeRef = doc(db, "codes", codeId);
                    const codeDoc = await transaction.get(codeRef);
                    if (!codeDoc.exists()) {
                         const generatedCode = "BLISS-" + Math.random().toString(36).substring(2, 6).toUpperCase();
                         transaction.set(codeRef, { uniqueCode: generatedCode, used: false });
                         nextCode = generatedCode;
                    } else {
                        nextCode = codeDoc.data().uniqueCode;
                    }
                    transaction.set(counterRef, { count: newCount });
                });
                return nextCode;
            } catch (e) {
                console.error("Transaction failed: ", e);
                return "ERROR-CODE";
            }
        }

        spinTrigger.addEventListener('click', async () => {
            if (isSpinning) return;
            
            let limitSpins = true;
            if (db) {
                const limitRef = doc(db, "config", "spinLimit");
                try {
                    const docSnap = await getDoc(limitRef);
                    if (docSnap.exists() && docSnap.data().enabled === false) {
                        limitSpins = false;
                    }
                } catch (e) { console.error("Could not check spin limit", e)}
            }
            
            if (limitSpins) {
                const today = new Date().toISOString().split('T')[0];
                if (localStorage.getItem('bakedBlissLastSpin') === today) {
                    alreadySpunModal.classList.remove('hidden');
                    setTimeout(() => {
                        alreadySpunModal.querySelector('div.transform').classList.remove('scale-95', 'opacity-0');
                    }, 10);
                    return;
                }
            }

            isSpinning = true;
            let winningPrizeIndex = 0;
            if (db) {
                const strategyRef = doc(db, "config", "strategy");
                const docSnap = await getDoc(strategyRef);
                const currentStrategy = docSnap.exists() ? docSnap.data().currentStrategy : "day1";
                winningPrizeIndex = await getRiggedPrize(currentStrategy);
            } else {
                 winningPrizeIndex = Math.floor(Math.random() * prizes.length);
            }
            const degreesPerSegment = 360 / prizes.length;
            const totalSpins = 360 * 5; 
            const targetRotation = 360 - (winningPrizeIndex * degreesPerSegment);
            const randomJitter = (Math.random() - 0.5) * (degreesPerSegment * 0.8); 
            const finalRotation = totalSpins + targetRotation - randomJitter;
            currentRotation = finalRotation;
            wheelSVG.style.transition = 'transform 4s cubic-bezier(0.25, 1, 0.5, 1)';
            wheelSVG.style.transform = `rotate(${currentRotation}deg)`;
            setTimeout(() => showResult(winningPrizeIndex), 4100);
        });
        
        async function showResult(prizeIndex) {
            currentPrize = prizes[prizeIndex]; 
            prizeNameEl.textContent = currentPrize;
            
            prizeIdEl.textContent = "Generating...";
            resultModal.querySelector('div.transform').classList.remove('scale-95', 'opacity-0');
            resultModal.classList.remove('hidden');
            triggerConfetti();

            const uniqueCode = await getNextCode();
            prizeIdEl.textContent = uniqueCode;

            if (db) {
                try {
                    await addDoc(collection(db, "spins"), {
                        prizeWon: currentPrize,
                        uniqueCode: uniqueCode,
                        redeemed: false,
                        timestamp: serverTimestamp()
                    });
                } catch (error) {
                    console.error("Error writing spin to Firestore: ", error);
                }
            }
            
            const today = new Date().toISOString().split('T')[0];
            localStorage.setItem('bakedBlissLastSpin', today);
            
            geminiButtons.classList.remove('hidden');
            [fortuneLoading, fortuneResult, funFactLoading, funFactResult, nicknameLoading, nicknameResult].forEach(el => el.classList.add('hidden'));
        }

        closeModalButton.addEventListener('click', () => {
            resultModal.querySelector('div.transform').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                resultModal.classList.add('hidden');
                isSpinning = false;
            }, 300);
        });

        closeAlreadySpunModalButton.addEventListener('click', () => {
            alreadySpunModal.querySelector('div.transform').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                alreadySpunModal.classList.add('hidden');
            }, 300);
        });

        fortuneButton.addEventListener('click', async () => {
            geminiButtons.classList.add('hidden');
            fortuneLoading.classList.remove('hidden');
            [funFactResult, nicknameResult].forEach(el => el.classList.add('hidden'));
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const systemPrompt = "You are the joyful baker behind 'Baked Bliss'. Your fortunes are always short (1-2 sentences), sweet, funny, and themed around desserts, cakes, pastries, and happiness. Never mention being an AI.";
            const userQuery = `I just won '${currentPrize}'. Give me a sweet, happy fortune related to that!`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { throw new Error(`API error: ${response.status}`); }
                const result = await response.json();
                const fortune = result.candidates?.[0]?.content?.parts?.[0]?.text;
                fortuneText.textContent = fortune ? fortune.trim() : "Your future is sweet, but the oven is busy! Try again later.";
            } catch (error) {
                console.error("Error fetching fortune:", error);
                fortuneText.textContent = "The recipe for your fortune got misplaced! Just know it's a sweet one.";
            } finally {
                fortuneLoading.classList.add('hidden');
                fortuneResult.classList.remove('hidden');
            }
        });

        funFactButton.addEventListener('click', async () => {
            geminiButtons.classList.add('hidden');
            funFactLoading.classList.remove('hidden');
            [fortuneResult, nicknameResult].forEach(el => el.classList.add('hidden'));
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const systemPrompt = "You are a cheerful baker at 'Baked Bliss'. You know everything about desserts. Provide a single, fascinating fun fact or a creative serving suggestion for the item mentioned. Keep it short, exciting, and fun. Never mention being an AI.";
            const userQuery = `Based on the prize I won, which is '${currentPrize}', give me a fun fact or serving suggestion. If the prize is generic like 'Double Your Luck', give me a general fun fact about celebration cakes.`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { throw new Error(`API error: ${response.status}`); }
                const result = await response.json();
                const funFact = result.candidates?.[0]?.content?.parts?.[0]?.text;
                funFactText.textContent = funFact ? funFact.trim() : "I'm drawing a blank! Must be the sugar rush. But I know for a fact you'll love our treats!";
            } catch (error) {
                console.error("Error fetching fun fact:", error);
                funFactText.textContent = "Our book of facts is currently being proof-read! Please try again in a moment.";
            } finally {
                funFactLoading.classList.add('hidden');
                funFactResult.classList.remove('hidden');
            }
        });

        nicknameButton.addEventListener('click', async () => {
            geminiButtons.classList.add('hidden');
            nicknameLoading.classList.remove('hidden');
            [fortuneResult, funFactResult].forEach(el => el.classList.add('hidden'));
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const systemPrompt = "You are a creative and funny naming expert for desserts. Your job is to give a single, epic, and quirky nickname to a treat. Respond with ONLY the nickname in quotation marks, and nothing else.";
            const userQuery = `Give a nickname to the prize I won: '${currentPrize}'. If the prize is generic like 'Double Your Luck', give a nickname to 'a lucky moment'.`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { throw new Error(`API error: ${response.status}`); }
                const result = await response.json();
                let nickname = result.candidates?.[0]?.content?.parts?.[0]?.text;
                nicknameText.textContent = nickname ? nickname.trim().replace(/"/g, '') : "The Unnameable Treat";
            } catch (error) {
                console.error("Error fetching nickname:", error);
                nicknameText.textContent = "The Delicious Mystery";
            } finally {
                nicknameLoading.classList.add('hidden');
                nicknameResult.classList.remove('hidden');
            }
        });

        function triggerConfetti() {
            confettiContainer.innerHTML = '';
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                const colors = ['#f87171', '#fb923c', '#facc15', '#4ade80', '#38bdf8', '#a78bfa'];
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDelay = Math.random() * -3 + 's';
                confettiContainer.appendChild(confetti);
            }
        }
    </script>
</body>
</html>

