<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baked Bliss - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Pacifico&display=swap" rel="stylesheet">
    <style> 
        body { 
            background-color: #f1f5f9; /* Slate 100 */
            font-family: 'Nunito', sans-serif;
        } 
        .baking-bliss-title {
            font-family: 'Pacifico', cursive;
        }
        /* Styling for the toggle switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #ec4899; /* Pink 500 */
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #ec4899; /* Pink 500 */
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Auth Gate -->
    <div id="auth-gate" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
            <h1 class="text-4xl font-bold text-center text-pink-500 mb-2 baking-bliss-title">Baked Bliss</h1>
            <h2 class="text-xl text-gray-600 text-center mb-8">Admin Login</h2>
            <input type="password" id="password" placeholder="Enter password" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-pink-400 transition">
            <button id="loginButton" class="w-full bg-pink-500 text-white font-bold py-3 rounded-lg hover:bg-pink-600 transition-colors transform hover:scale-105">Login</button>
        </div>
    </div>

    <!-- Main Admin Content -->
    <main id="admin-content" class="hidden p-4 md:p-8">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10">
            <h1 class="text-4xl font-black text-pink-500 baking-bliss-title">Baked Bliss</h1>
            <p class="text-xl text-gray-600 font-semibold">Control Panel</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Controls Column -->
            <div class="flex flex-col gap-8">
                <!-- Daily Strategy Switch -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                        Daily Strategy Switch
                    </h2>
                    <div id="strategy-options" class="grid grid-cols-2 gap-4"></div>
                    <p id="save-status" class="mt-4 text-green-600 font-semibold h-6"></p>
                </div>

                <!-- One Spin Per User Toggle -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                        "One Spin Per User" Limit
                    </h2>
                    <div class="flex items-center justify-between">
                        <p class="text-gray-600">Enforce one spin per browser (resets daily).</p>
                        <div class="relative inline-block w-14 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="spinLimitToggle" class="toggle-checkbox absolute block w-8 h-8 -left-1 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="spinLimitToggle" class="toggle-label block overflow-hidden h-8 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                     <p id="spin-limit-status" class="mt-4 text-green-600 font-semibold h-6"></p>
                </div>
            </div>
            
            <!-- AI Insights -->
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                    AI Business Insights
                </h2>
                <p class="text-gray-600 mb-4">Analyze today's spin data to get a summary and actionable advice for tomorrow.</p>
                <button id="generateSummaryButton" class="w-full md:w-auto bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition-colors transform hover:scale-105">
                    Generate Daily Summary
                </button>
                <div id="summaryLoading" class="hidden my-4 text-gray-500">
                    Analyzing data and consulting the AI...
                </div>
                <div id="summaryResult" class="hidden mt-4 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                    <!-- AI summary will be displayed here -->
                </div>
            </div>
        </div>


        <!-- Live Spin Tracker -->
        <div class="bg-white p-6 rounded-2xl shadow-lg">
            <h2 class="text-xl font-bold flex items-center gap-2 mb-4">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                Live Spin Tracker
            </h2>
            
            <!-- New Search Bar -->
            <div class="relative mb-4">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>
                <input type="text" id="searchInput" placeholder="Search by unique code..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-pink-400 transition">
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prize Won</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unique Code</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody id="spins-table" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

    </main>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, orderBy, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('loginButton');
        const authGate = document.getElementById('auth-gate');
        const adminContent = document.getElementById('admin-content');
        const CORRECT_PASSWORD = "bliss";

        let db;
        let allSpins = [];

        loginButton.addEventListener('click', () => {
            if (passwordInput.value === CORRECT_PASSWORD) {
                authGate.remove(); // Remove login form from DOM
                adminContent.classList.remove('hidden');
                document.body.classList.add('bg-slate-100'); // Add bg color to body
                initializeAppAndRun();
            } else {
                alert('Incorrect password!');
            }
        });

        async function initializeAppAndRun() {
            const firebaseConfig = {
                apiKey: "AIzaSyDauZ3AwxVRK_mvRT89qsXW4g84cgq8Rjc",
                authDomain: "bakingblisswheel.firebaseapp.com",
                projectId: "bakingblisswheel",
                storageBucket: "bakingblisswheel.appspot.com",
                messagingSenderId: "1020604226536",
                appId: "1:1020604226536:web:2d50898e9dc5193d88225d"
            };

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                setupStrategySwitch();
                setupSpinLimitSwitch();
                setupSpinTracker();
                setupAISummaryGenerator();
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                adminContent.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert"><p class="font-bold">Connection Error</p><p>Could not connect to Firebase. Check your internet and the Firebase config.</p></div>`;
            }
        }

        async function setupStrategySwitch() {
            const strategyOptionsContainer = document.getElementById('strategy-options');
            const saveStatus = document.getElementById('save-status');
            const strategies = ["day1", "day2", "day3", "day4"];
            const strategyRef = doc(db, "config", "strategy");

            strategies.forEach(strategy => {
                const label = document.createElement('label');
                label.className = "flex items-center space-x-3 p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-pink-50 transition";
                label.innerHTML = `
                    <input type="radio" name="strategy" value="${strategy}" class="form-radio h-5 w-5 text-pink-600 focus:ring-pink-500">
                    <span class="font-semibold capitalize text-gray-700">${strategy.replace('day', 'Day ')}</span>
                `;
                strategyOptionsContainer.appendChild(label);
            });

            try {
                const docSnap = await getDoc(strategyRef);
                if (docSnap.exists()) {
                    const currentStrategy = docSnap.data().currentStrategy;
                    const radioInput = document.querySelector(`input[name="strategy"][value="${currentStrategy}"]`);
                    if (radioInput) radioInput.checked = true;
                }
            } catch (error) {
                console.error("Error loading current strategy:", error);
                saveStatus.textContent = "Error loading strategy.";
            }

            strategyOptionsContainer.addEventListener('change', async (e) => {
                if (e.target.name === 'strategy') {
                    const newStrategy = e.target.value;
                    try {
                        await setDoc(strategyRef, { currentStrategy: newStrategy });
                        saveStatus.textContent = `Strategy set to: ${newStrategy.replace('day', 'Day ')}!`;
                        setTimeout(() => saveStatus.textContent = '', 3000);
                    } catch (error) {
                         console.error("Error saving strategy:", error);
                         saveStatus.textContent = "Error saving. Check console.";
                    }
                }
            });
        }
        
        async function setupSpinLimitSwitch() {
            const toggle = document.getElementById('spinLimitToggle');
            const statusEl = document.getElementById('spin-limit-status');
            const limitRef = doc(db, "config", "spinLimit");

            try {
                const docSnap = await getDoc(limitRef);
                if (docSnap.exists() && docSnap.data().enabled) {
                    toggle.checked = true;
                }
            } catch (error) {
                console.error("Error loading spin limit:", error);
            }

            toggle.addEventListener('change', async () => {
                const isEnabled = toggle.checked;
                try {
                    await setDoc(limitRef, { enabled: isEnabled });
                    statusEl.textContent = `Spin limit is now ${isEnabled ? 'ON' : 'OFF'}!`;
                    setTimeout(() => statusEl.textContent = '', 3000);
                } catch (error) {
                    console.error("Error saving spin limit:", error);
                    statusEl.textContent = 'Error saving setting.';
                }
            });
        }

        function setupSpinTracker() {
            const spinsTable = document.getElementById('spins-table');
            const searchInput = document.getElementById('searchInput');
            const q = query(collection(db, "spins"), orderBy("timestamp", "desc"));

            onSnapshot(q, (querySnapshot) => {
                allSpins = [];
                querySnapshot.forEach((doc) => {
                    allSpins.push({ id: doc.id, ...doc.data() });
                });
                renderTable();
            }, (error) => {
                console.error("Firestore listener error:", error);
                spinsTable.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-red-600">Error connecting to the spin database.</td></tr>`;
            });

            function renderTable() {
                const searchTerm = searchInput.value.toUpperCase();
                const filteredSpins = allSpins.filter(spin => spin.uniqueCode && spin.uniqueCode.toUpperCase().includes(searchTerm));

                spinsTable.innerHTML = '';
                if (filteredSpins.length === 0) {
                    spinsTable.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">No matching spins found.</td></tr>`;
                    return;
                }

                filteredSpins.forEach(spin => {
                    const tr = document.createElement('tr');
                    tr.className = `hover:bg-gray-50 transition-colors ${spin.redeemed ? 'bg-gray-100 text-gray-400' : 'bg-white'}`;
                    
                    const time = spin.timestamp ? new Date(spin.timestamp.seconds * 1000).toLocaleTimeString() : 'N/A';
                    const statusButton = `<button data-id="${spin.id}" class="redeem-button ${spin.redeemed ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600'} text-white font-bold py-1 px-3 rounded text-sm transition-colors" ${spin.redeemed ? 'disabled' : ''}>${spin.redeemed ? 'Redeemed' : 'Mark Redeemed'}</button>`;

                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${time}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">${spin.prizeWon}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-blue-600">${spin.uniqueCode}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${statusButton}</td>
                    `;
                    spinsTable.appendChild(tr);
                });
            }

            searchInput.addEventListener('input', renderTable);

            spinsTable.addEventListener('click', async (e) => {
                if (e.target.classList.contains('redeem-button') && !e.target.disabled) {
                    const spinId = e.target.dataset.id;
                    const spinDocRef = doc(db, "spins", spinId);
                    e.target.disabled = true;
                    e.target.textContent = 'Updating...';
                    await updateDoc(spinDocRef, { redeemed: true });
                }
            });
        }
        
        function setupAISummaryGenerator() {
            const generateButton = document.getElementById('generateSummaryButton');
            const loadingEl = document.getElementById('summaryLoading');
            const resultEl = document.getElementById('summaryResult');

            generateButton.addEventListener('click', async () => {
                loadingEl.classList.remove('hidden');
                resultEl.classList.add('hidden');

                const today = new Date().toISOString().split('T')[0];
                const todaysSpins = allSpins.filter(spin => {
                    if (!spin.timestamp) return false;
                    const spinDate = new Date(spin.timestamp.seconds * 1000).toISOString().split('T')[0];
                    return spinDate === today;
                });

                if (todaysSpins.length === 0) {
                    resultEl.innerHTML = "<p>No spins recorded yet for today. Nothing to analyze!</p>";
                    loadingEl.classList.add('hidden');
                    resultEl.classList.remove('hidden');
                    return;
                }

                const prizeCounts = todaysSpins.reduce((acc, spin) => {
                    acc[spin.prizeWon] = (acc[spin.prizeWon] || 0) + 1;
                    return acc;
                }, {});
                
                const hourlyCounts = todaysSpins.reduce((acc, spin) => {
                    const hour = new Date(spin.timestamp.seconds * 1000).getHours();
                    acc[hour] = (acc[hour] || 0) + 1;
                    return acc;
                }, {});

                let dataSummary = `Total Spins Today: ${todaysSpins.length}\n`;
                dataSummary += "Prize Breakdown:\n" + Object.entries(prizeCounts).map(([k, v]) => `- ${k}: ${v} times`).join('\n') + "\n";
                dataSummary += "Spins per Hour:\n" + Object.entries(hourlyCounts).map(([k, v]) => `- Hour ${k}: ${v} spins`).join('\n');

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const systemPrompt = "You are a friendly business analyst for a festival bakery stall called 'Baked Bliss'. Analyze the provided daily spin data. Provide a very short, bulleted summary of the key trend (e.g., most popular prize, busiest hour) and then give ONE actionable, creative suggestion for tomorrow to increase sales or engagement. Keep the tone encouraging and positive.";
                const userQuery = `Here is the data for today:\n\n${dataSummary}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    const analysis = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    resultEl.innerHTML = analysis ? analysis.replace(/\n/g, '<br>') : "Could not generate a summary. The AI kitchen might be closed!";
                } catch (error) {
                    console.error("Error generating AI summary:", error);
                    resultEl.innerHTML = "<p>There was an error getting insights. Please check the console.</p>";
                } finally {
                    loadingEl.classList.add('hidden');
                    resultEl.classList.remove('hidden');
                }
            });
        }

    </script>
</body>
</html>

